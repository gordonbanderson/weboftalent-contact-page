language: php
sudo: false
addons:
    apt:
        packages:
            - tidy
php:
    - 5.3
    - 5.4
    - 5.5
    - 5.6
    - hhvm-nightly
    - !!float 7
before_install:
    - 'pip install --user codecov'
env:
    global:
        - 'DB=MYSQL CORE_RELEASE=3.1'
        - MODULE_PATH=contactpage
        - COVERAGE=0
matrix:
    allow_failures:
        -
            php: hhvm-nightly
        -
            php: !!float 7
    include:
        -
            php: 5.6
            env: DB=PGSQL
        -
            php: 5.6
            env: DB=SQLITE
        -
            php: hhvm
            env: DB=MYSQL
        -
            php: 5.6
            env: 'DB=MYSQL CORE_RELEASE=3.2 COVERAGE=1'
        -
            php: 5.6
            env: 'DB=PGSQL CORE_RELEASE=3.2'
        -
            php: 5.6
            env: 'DB=SQLITE CORE_RELEASE=3.2'
        -
            php: 5.5
            env: 'DB=MYSQL CORE_RELEASE=3.2'
        -
            php: 5.4
            env: 'DB=MYSQL CORE_RELEASE=3.2'
        -
            php: 5.3
            env: 'DB=MYSQL CORE_RELEASE=3.2'
        -
            php: hhvm
            env: 'DB=MYSQL CORE_RELEASE=3.2'
        -
            php: 7.4
            env: PHPCS_TEST=1
        -
            php: 7.4
            env: DUPLICATE_CODE_CHECK=1
        -
            php: 7.4
            env: LINT_CHECK=1
        -
            php: 7.4
            env: PHPSTAN_TEST=1
before_script:
    - 'phpenv rehash'
    - 'composer self-update || true'
    - 'git clone git://github.com/silverstripe-labs/silverstripe-travis-support.git ~/travis-support'
    - 'php ~/travis-support/travis_setup.php --source `pwd` --target ~/builds/ss'
    - 'cd ~/builds/ss'
    - 'if [[ $DUPLICATE_CODE_CHECK ]]; then sudo apt remove -y nodejs && curl -sL https://deb.nodesource.com/setup_14.x -o nodesource_setup.sh && sudo bash nodesource_setup.sh && sudo apt install -y build-essential nodejs && which npm && npm install jscpd@3.2.1  ;fi'
script:
    - 'if [ "$COVERAGE" = "0" ]; then vendor/bin/phpunit $MODULE_PATH/tests/; fi'
    - 'if [ "$COVERAGE" = "1" ]; then vendor/bin/phpunit --coverage-clover=coverage.clover $MODULE_PATH/tests/; fi'
    - 'if [[ $PHPCS_TEST ]]; then vendor/bin/phpcs --standard=ruleset.xml --extensions=php --tab-width=4 -sp src tests ; fi'
    - 'if [[ $DUPLICATE_CODE_CHECK ]]; then node_modules/jscpd/bin/jscpd src && node_modules/jscpd/bin/jscpd tests ; fi'
    - 'if [[ $LINT_CHECK ]]; then vendor/bin/parallel-lint src/ tests/ ; fi'
    - 'if [[ $PHPSTAN_TEST ]]; then vendor/bin/phpstan analyse --level=6 -c tests/phpstan.neon src/ ; fi'
after_script:
    - 'if [ "$COVERAGE" = "1" ]; then mv coverage.clover ~/build/$TRAVIS_REPO_SLUG/; fi'
    - 'cd ~/build/$TRAVIS_REPO_SLUG'
    - 'wget https://scrutinizer-ci.com/ocular.phar'
    - 'if [ "$COVERAGE" = "1" ]; then travis_retry codecov && travis_retry php ocular.phar code-coverage:upload --format=php-clover coverage.clover; fi'
